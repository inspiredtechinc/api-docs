name: Docs Preview

on:
  repository_dispatch:
    types: [spec-sync]

concurrency:
  group: docs-preview-${{ github.event.client_payload.spec_branch }}
  cancel-in-progress: false

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      # 0: debug incoming event payload
      - name: 🐛 Debug incoming dispatch payload
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "=== DISPATCH PAYLOAD ==="
          echo "event_type:      ${{ github.event.client_payload.event_type }}"
          echo "spec_path:       ${{ github.event.client_payload.spec_path }}"
          echo "spec_branch:     ${{ github.event.client_payload.spec_branch }}"
          echo "spec_pr_number:  ${{ github.event.client_payload.spec_pr_number }}"
          echo "ms_pr_number:    ${{ github.event.client_payload.ms_pr_number }}"
          echo "ms_repo:         ${{ github.event.client_payload.ms_repo }}"
          echo "========================"

      # 0.1: early exit if not a PR event (opened/synchronize/reopened)
      - name: Early exit if not a PR event
        if: >
          github.event_name == 'repository_dispatch' && !contains(fromJson('["opened","synchronize","reopened"]'),
                   github.event.client_payload.event_type)
        run: |
          echo "Not a PR event (event_type=${{ github.event.client_payload.event_type }}); exiting."
          exit 0

      # 1: Checkout the api-docs repo code
      - name: Checkout api-docs
        uses: actions/checkout@v3

      # 2: Checkout api-specs and copy in the updated spec
      - name: Checkout api-specs
        uses: actions/checkout@v3
        with:
          repository: inspiredtechinc/api-specs
          ref: ${{ github.event.client_payload.spec_branch }}
          token: ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          path: api-specs-repo

      - name: Copy updated spec into docs folder
        run: |
          mkdir -p specs/services
          cp api-specs-repo/${{ github.event.client_payload.spec_path }} specs/services/
          echo "Copied:" && ls -l specs/services/$(basename "${{ github.event.client_payload.spec_path }}")

      # 3: install dependencies
      - name: Install dependencies
        run: npm install

      # 4: Set BUILD_ENV using payload or default to main
      - name: Set BUILD_ENV
        run: |
          BASE_BRANCH="${{ github.event.client_payload.base_branch }}"
          BASE_BRANCH="${BASE_BRANCH:-main}"
          if [ "$BASE_BRANCH" = "main" ]; then
            echo "BUILD_ENV=staging" >> $GITHUB_ENV
          else
            echo "BUILD_ENV=preview" >> $GITHUB_ENV
          fi
          echo "Using BUILD_ENV=$BUILD_ENV (base_branch=$BASE_BRANCH)"

      # 5: generate the docs (double-run per request)
      - name: Generate docs
        run: node scripts/generate-docs.js
        env:
          BUILD_ENV: ${{ env.BUILD_ENV }}

      - name: Regenerate main index.html
        run: node scripts/generate-docs.js --index-only

      # 6: merge into gh-pages and push
      - name: Merge & publish to gh-pages
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # clone or fetch gh-pages
          git clone --depth=1 --branch gh-pages https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git gh-pages-tmp || true
          mkdir -p public/generated

          # merge old generated files
          if [ -d gh-pages-tmp/generated ]; then
            cp -rv gh-pages-tmp/generated/* public/generated/ || true
          fi

          # copy this branch’s build
          mkdir -p "public/generated/${{ env.BUILD_ENV }}"
          mkdir -p "public/generated/${{ github.event.client_payload.spec_branch }}"
          cp -rv public/generated/"${{ env.BUILD_ENV }}"/* "public/generated/${{ github.event.client_payload.spec_branch }}/" || true

          # commit & push all updates
          cd public
          git init
          git remote add origin https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git
          git checkout -B gh-pages
          git add generated
          git commit -m "Docs Preview: ${{ github.event.client_payload.spec_branch }} (${${{ github.event.client_payload.event_type }}})"
          git push --force origin gh-pages
          cd ..
          rm -rf gh-pages-tmp

      # 7: Comment back on microservice PR
      - name: Comment back on microservice PR
        if: >
          github.event_name == 'repository_dispatch' &&
          github.event.client_payload.ms_repo &&
          github.event.client_payload.ms_pr_number
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          repository: ${{ github.event.client_payload.ms_repo }}
          issue-number: ${{ github.event.client_payload.ms_pr_number }}
          body: |
            🚀 **Preview Documentation**
            https://inspiredtechinc.github.io/api-docs/generated/${{ github.event.client_payload.spec_branch }}/index.html

      # 8: Comment back on api-specs PR
      - name: Comment back on api-specs PR
        if: >
          github.event_name == 'repository_dispatch' &&
          github.event.client_payload.spec_pr_number
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          repository: inspiredtechinc/api-specs
          issue-number: ${{ github.event.client_payload.spec_pr_number }}
          body: |
            🚀 **Preview Documentation**
            https://inspiredtechinc.github.io/api-docs/generated/${{ github.event.client_payload.spec_branch }}/index.html

      # 9: Cleanup on PR close
      - name: Cleanup preview on PR close
        if: >
          github.event_name == 'repository_dispatch' &&
          github.event.client_payload.event_type == 'closed'
        run: |
          git clone --depth=1 --branch gh-pages https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git gh-pages-clean
          cd gh-pages-clean
          rm -rf public/generated/${{ github.event.client_payload.spec_branch }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -am "Remove preview for ${{ github.event.client_payload.spec_branch }}"
          git push origin gh-pages
