name: Docs Preview

on:
  repository_dispatch:
    types: [spec-sync]

concurrency:
  group: docs-preview-${{ github.event.client_payload.spec_branch }}
  cancel-in-progress: false

jobs:
  preview:
    if: >
      github.event_name == 'repository_dispatch' &&
      contains(fromJson('["opened","synchronize","reopened","merged"]'),
               github.event.client_payload.event_type)
    runs-on: ubuntu-latest

    steps:
      # 1: Debug incoming dispatch payload
      - name: 🐛 Debug incoming dispatch payload
        run: |
          echo "=== DISPATCH PAYLOAD ==="
          echo "event_type:      ${{ github.event.client_payload.event_type }}"
          echo "spec_branch:     ${{ github.event.client_payload.spec_branch }}"
          echo "spec_pr_number:  ${{ github.event.client_payload.spec_pr_number }}"
          echo "ms_pr_number:    ${{ github.event.client_payload.ms_pr_number }}"
          echo "ms_repo:         ${{ github.event.client_payload.ms_repo }}"
          echo "========================"
          
      # 2: Check available disk space
      - name: 💾 Check disk space
        run: |
          echo "=== DISK SPACE BEFORE ==="
          df -h
          du -sh /home/runner || true
          echo "========================="

      # 3: Checkout api-specs & copy spec
      - name: Checkout api-specs & copy spec
        if: github.event.client_payload.event_type != 'closed'
        uses: actions/checkout@v3
        with:
          repository: inspiredtechinc/api-specs
          ref:         ${{ github.event.client_payload.spec_branch }}
          token:       ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          path:        api-specs-repo


      # 4: Copy all service specs
      - name: Copy all service specs
        if: github.event.client_payload.event_type != 'closed'
        run: |
          mkdir -p specs/services
          cp api-specs-repo/services/*.yaml specs/services/ 2>/dev/null || true
          cp api-specs-repo/services/*.yml specs/services/ 2>/dev/null || true

      # 5: Copy all gateway specs
      - name: Copy all gateway specs
        if: github.event.client_payload.event_type != 'closed'
        run: |
          mkdir -p specs/gateways
          cp api-specs-repo/gateway/*.yaml specs/gateways/ 2>/dev/null || true
          cp api-specs-repo/gateway/*.yml specs/gateways/ 2>/dev/null || true
          cp api-specs-repo/gateway/config.json specs/gateways/ 2>/dev/null || true

      # 6: Install dependencies
      - name: Install dependencies
        run: npm install

      # 7: Determine BUILD_ENV and PUBLISH_DIR
      - name: Set ENV values
        run: |
          EVENT="${{ github.event.client_payload.event_type }}"
          SERVICE="${{ github.event.client_payload.ms_repo }}" # e.g., inspiredtechinc/project-x-user-service
          SERVICE_NAME=$(basename "$SERVICE")                  # e.g., project-x-user-service
          PR_NUMBER="${{ github.event.client_payload.ms_pr_number }}"

          if [ "$EVENT" = "merged" ]; then
            # echo "BUILD_ENV=staging" >> $GITHUB_ENV
            # echo "PUBLISH_DIR=generated/staging/$SERVICE_NAME" >> $GITHUB_ENV
             echo "BUILD_ENV=staging" >> $GITHUB_ENV
             echo "PUBLISH_DIR=generated/staging" >> $GITHUB_ENV
          else
            echo "BUILD_ENV=preview" >> $GITHUB_ENV
            echo "PUBLISH_DIR=generated/sync/$SERVICE_NAME-pr$PR_NUMBER" >> $GITHUB_ENV
          fi


      # 8: Generate the docs
      - name: Generate docs
        if: github.event.client_payload.event_type != 'closed'
        run: npm run generate:docs
        env:
          BUILD_ENV: ${{ env.BUILD_ENV }}

      # - name: Regenerate main index.html
      #   if: github.event.client_payload.event_type != 'closed'
      #   run: node scripts/generate-docs.js --index-only

      # 9: Check disk space after generation
      - name: 💾 Check disk space after generation
        if: github.event.client_payload.event_type != 'closed'
        run: |
          echo "=== DISK SPACE AFTER GENERATION ==="
          df -h
          du -sh public/ || true
          du -sh node_modules/ || true
          echo "===================================="

      # 10: Merge any existing previews so we don't wipe other branches
      - name: Merge existing previews
        if: github.event.client_payload.event_type != 'closed'
        run: |
          echo "=== DISK SPACE BEFORE CLONE ==="
          df -h
          echo "==============================="
          
          # Use sparse checkout to only get the generated folder
          git clone --depth=1 --branch gh-pages --filter=blob:none \
            https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git tmp
          
          cd tmp
          git sparse-checkout init --cone
          git sparse-checkout set generated
          cd ..
          
          # Only copy if the generated folder exists
          if [ -d "tmp/generated" ]; then
            cp -r tmp/generated public/ || true
            echo "Copied existing previews"
          else
            echo "No existing previews found"
          fi
          
          # Clean up immediately
          rm -rf tmp
          
          echo "=== DISK SPACE AFTER MERGE ==="
          df -h
          du -sh public/ || true
          echo "==============================="

     
        # 11: Rebuild root index so the closed‑PR card disappears
      - name: Regenerate root index.html
        if: github.event.client_payload.event_type == 'closed'
        run: |
          node scripts/generate-docs.js --index-only
      # 12: Clean up before publish
      - name: Clean up before publish
        if: github.event.client_payload.event_type != 'closed'
        run: |
          # Remove any unnecessary files to save space
          rm -rf api-specs-repo || true
          rm -rf node_modules/.cache || true
          
          echo "=== FINAL DISK SPACE CHECK ==="
          df -h
          du -sh public/ || true
          echo "==============================="
          
      - name: Publish to GitHub Pages
        if: github.event.client_payload.event_type != 'closed'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token:    ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          publish_dir:     public
          publish_branch:  gh-pages
          destination_dir: ${{ env.PUBLISH_DIR }}     # <— put previews/staging in the right folder
          user_name:       GitHub Actions
          user_email:      actions@github.com
          keep_files:      true

      # 13: Publish to GitHub Pages
      - name: Trigger Staging API Gateway Deployment
        if: github.event.client_payload.event_type == 'merged'
        uses: peter-evans/repository-dispatch@v2
        with:
          token:       ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          repository:  inspiredtechinc/api-specs
          event-type:  deploy-staging-gateway
          client-payload: |
            {
              "source": "api-docs",
              "branch": "${{ github.event.client_payload.spec_branch }}",
              "sha":    "${{ github.sha }}"
            }

      
        # 14: Trigger Staging API Gateway Deployment
      - name: Ask api-specs to post preview comment
        uses: peter-evans/repository-dispatch@v2
        with:
          token:       ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          repository:  inspiredtechinc/api-specs
          event-type:  post-preview-comment
          client-payload: |
            {
              "event_type":     "${{ github.event.client_payload.event_type }}",
              "ms_repo":        "${{ github.event.client_payload.ms_repo }}",
              "ms_pr_number":   "${{ github.event.client_payload.ms_pr_number }}",
              "preview_url":    "https://inspiredtechinc.github.io/api-docs/${{ env.PUBLISH_DIR }}/index.html",
              "spec_pr_number":"${{ github.event.client_payload.spec_pr_number }}"
            }

      # 15: Tell api-specs to post preview comment
      - name: Log cleanup message
        if: github.event.client_payload.event_type == 'closed'
        run: |
          echo "Cleaning up preview for ${{ github.event.client_payload.spec_branch }}"

      # 16: Log that we’re tearing down the preview
      # 17: Actually delete the preview directory
      - name: Cleanup preview on PR close
        if: github.event.client_payload.event_type == 'closed'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token:     ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          publish_dir:      /dev/null
          destination_dir:  generated/${{ github.event.client_payload.spec_branch }}
          user_name:        GitHub Actions
          user_email:       actions@github.com
          keep_files:       false


