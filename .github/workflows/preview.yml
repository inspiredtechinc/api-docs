name: Docs Preview

on:
  repository_dispatch:
    types: [spec-sync]

concurrency:
  group: docs-preview-${{ github.event.client_payload.spec_branch }}
  cancel-in-progress: false

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      # early exit if not an â€œopenedâ€/â€œsynchronizeâ€/â€œreopenedâ€ dispatch
      - name: Early exit if not a PR event
        if: >
          github.event_name == 'repository_dispatch' && !contains(fromJson('["opened","synchronize","reopened"]'), github.event.client_payload.event_type)
        run: |
          echo "Not a PR event (event_type=${{ github.event.client_payload.event_type }}); exiting."
          exit 0

      # 1. checkout the api-docs repo code
      - name: Checkout api-docs
        uses: actions/checkout@v3

      # 2. checkout api-specs and copy in the updated spec
      - name: Checkout api-specs
        if: github.event_name == 'repository_dispatch'
        uses: actions/checkout@v3
        with:
          repository: inspiredtechinc/api-specs
          ref: ${{ github.event.client_payload.spec_branch }}
          token: ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          path: api-specs-repo

      - name: Copy updated spec into docs folder
        if: github.event_name == 'repository_dispatch'
        run: |
          # Ensure target directory exists
          mkdir -p specs/services

          # Copy from api-specs using the full path from the payload
          cp api-specs-repo/${{ github.event.client_payload.spec_path }} specs/services/

          # (Optional) Print out what we copied for debugging
          echo "Copied:"
          ls -l specs/services/$(basename "${{ github.event.client_payload.spec_path }}")


      # 3. install dependencies
      - name: Install dependencies
        run: npm install

      # 4. fix BUILD_ENV logic to use the dispatch payload
      - name: Set BUILD_ENV
        run: |
          # Use base_branch from payload (default to main)
          BASE_BRANCH="${{ github.event.client_payload.base_branch || 'main' }}"
          if [ "$BASE_BRANCH" = "main" ]; then
            echo "BUILD_ENV=staging" >> $GITHUB_ENV
          else
            echo "BUILD_ENV=preview" >> $GITHUB_ENV
          fi
          echo "Using BUILD_ENV=$BUILD_ENV (base_branch=$BASE_BRANCH)"

      # 5. generate the docs (doubleâ€run is left intact per your request)
      - name: Generate docs
        run: node scripts/generate-docs.js
        env:
          BUILD_ENV: ${{ env.BUILD_ENV }}

      - name: Regenerate main index.html
        run: node scripts/generate-docs.js --index-only

      # 7. merge into ghâ€‘pages and PUSH it so previews actually appear/disappear
      - name: Merge & publish to gh-pages
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # clone or fetch gh-pages
          git clone --depth=1 --branch gh-pages https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git gh-pages-tmp || true
          mkdir -p public/generated

          # merge old generated files
          if [ -d gh-pages-tmp/generated ]; then
            cp -rv gh-pages-tmp/generated/* public/generated/ || true
          fi

          # copy this branchâ€™s build
          mkdir -p "public/generated/${{ env.BUILD_ENV }}"
          cp -rv public/generated/"${{ env.BUILD_ENV }}"/* "public/generated/${{ github.event.client_payload.spec_branch }}/" || true

          # commit & push all updates (including deletions on close)
          cd public
          git init
          git remote add origin https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git
          git checkout -B gh-pages
          git add generated
          git commit -m "Docs Preview: ${{ github.event.client_payload.spec_branch }} (${{
            github.event.client_payload.event_type }})"
          git push --force origin gh-pages
          cd ..

          # cleanup
          rm -rf gh-pages-tmp

      # 8. sticky comments back to the service & api-specs PRs
      - name: Comment back on microservice PR
        if: >
          github.event_name == 'repository_dispatch' &&
          github.event.client_payload.ms_repo &&
          github.event.client_payload.ms_pr_number
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          repository: ${{ github.event.client_payload.ms_repo }}
          issue-number: ${{ github.event.client_payload.ms_pr_number }}
          body: |
            ðŸš€ **Preview Documentation**
            https://inspiredtechinc.github.io/api-docs/generated/${{ github.event.client_payload.spec_branch }}/index.html

      - name: Comment back on api-specs PR
        if: >
          github.event_name == 'repository_dispatch' &&
          github.event.client_payload.spec_pr_number
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}
          repository: inspiredtechinc/api-specs
          issue-number: ${{ github.event.client_payload.spec_pr_number }}
          body: |
            ðŸš€ **Preview Documentation**
            https://inspiredtechinc.github.io/api-docs/generated/${{ github.event.client_payload.spec_branch }}/index.html

      # 9. cleanup on close (and push the deletion)
      - name: Cleanup preview on PR close
        if: >
          github.event_name == 'repository_dispatch' &&
          github.event.client_payload.event_type == 'closed'
        run: |
          # remove the branch folder and push
          git clone --depth=1 --branch gh-pages https://x-access-token:${{ secrets.OPENAPI_CICD_WORKFLOW_TOKEN }}@github.com/inspiredtechinc/api-docs.git gh-pages-clean
          cd gh-pages-clean
          rm -rf public/generated/${{ github.event.client_payload.spec_branch }}
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git commit -am "Remove preview for ${{ github.event.client_payload.spec_branch }}"
          git push origin gh-pages
